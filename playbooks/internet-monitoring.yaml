---
- name: Install internet monitoring exporters on Raspberry Pi
  hosts: raspberry_pi
  become: yes
  vars:
    speedtest_exporter_version: "3.5.4"
    blackbox_exporter_version: "0.25.0"
    monitored_websites:
      - "https://ashishra0.com"
      - "https://x.com"
      - "https://github.com"

  tasks:
    - name: Install required packages
      apt:
        name:
          - curl
          - gnupg
          - jq
        state: present

    - name: Remove old speedtest-cli package
      apt:
        name: speedtest-cli
        state: absent

    - name: Download Ookla GPG key
      get_url:
        url: https://packagecloud.io/ookla/speedtest-cli/gpgkey
        dest: /tmp/ookla-speedtest.key

    - name: Add Ookla GPG key to keyring
      shell: gpg --dearmor < /tmp/ookla-speedtest.key > /usr/share/keyrings/ookla-speedtest.gpg
      args:
        creates: /usr/share/keyrings/ookla-speedtest.gpg

    - name: Add Ookla speedtest repository
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/ookla-speedtest.gpg] https://packagecloud.io/ookla/speedtest-cli/debian/ {{ ansible_distribution_release }} main"
        state: present
        filename: ookla_speedtest-cli

    - name: Install Ookla speedtest
      apt:
        name: speedtest
        state: present
        update_cache: yes

    - name: Create textfile collector directory for node_exporter
      file:
        path: /var/lib/node_exporter/textfile_collector
        state: directory
        mode: "0755"

    - name: Create speedtest script
      copy:
        dest: /usr/local/bin/speedtest-metrics.sh
        content: |
          #!/bin/bash
          # Run Ookla speedtest and export metrics for Prometheus
          OUTPUT_FILE="/var/lib/node_exporter/textfile_collector/speedtest.prom"
          TEMP_FILE="${OUTPUT_FILE}.tmp"

          # Run speedtest with JSON output (timeout after 90 seconds)
          if ! RESULT=$(timeout 90 speedtest --accept-license --accept-gdpr --format=json 2>/dev/null); then
            # Mark as failed
            cat > "$TEMP_FILE" <<EOF
          # HELP speedtest_up Speedtest successful (1) or failed (0)
          # TYPE speedtest_up gauge
          speedtest_up 0
          EOF
            mv "$TEMP_FILE" "$OUTPUT_FILE"
            exit 0
          fi

          # Parse JSON results
          PING=$(echo "$RESULT" | jq -r '.ping.latency')
          JITTER=$(echo "$RESULT" | jq -r '.ping.jitter')
          DOWNLOAD_BPS=$(echo "$RESULT" | jq -r '.download.bandwidth')
          UPLOAD_BPS=$(echo "$RESULT" | jq -r '.upload.bandwidth')

          # Convert bytes per second to bits per second (multiply by 8)
          DOWNLOAD_BITS=$(echo "$DOWNLOAD_BPS * 8" | bc)
          UPLOAD_BITS=$(echo "$UPLOAD_BPS * 8" | bc)

          # Write metrics
          cat > "$TEMP_FILE" <<EOF
          # HELP speedtest_ping_ms Speedtest ping latency in milliseconds
          # TYPE speedtest_ping_ms gauge
          speedtest_ping_ms $PING
          # HELP speedtest_jitter_ms Speedtest jitter in milliseconds
          # TYPE speedtest_jitter_ms gauge
          speedtest_jitter_ms $JITTER
          # HELP speedtest_download_bits_per_second Download speed in bits per second
          # TYPE speedtest_download_bits_per_second gauge
          speedtest_download_bits_per_second $DOWNLOAD_BITS
          # HELP speedtest_upload_bits_per_second Upload speed in bits per second
          # TYPE speedtest_upload_bits_per_second gauge
          speedtest_upload_bits_per_second $UPLOAD_BITS
          # HELP speedtest_up Speedtest successful (1) or failed (0)
          # TYPE speedtest_up gauge
          speedtest_up 1
          EOF

          mv "$TEMP_FILE" "$OUTPUT_FILE"
        mode: "0755"

    - name: Update node_exporter service to use textfile collector
      copy:
        dest: /etc/systemd/system/node_exporter.service
        content: |
          [Unit]
          Description=Node Exporter
          After=network.target

          [Service]
          Type=simple
          User=node_exporter
          ExecStart=/usr/local/bin/node_exporter --collector.textfile.directory=/var/lib/node_exporter/textfile_collector
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    - name: Restart node_exporter
      systemd:
        name: node_exporter
        state: restarted
        daemon_reload: yes

    - name: Create speedtest cron job (run every 5 minutes)
      cron:
        name: "Run speedtest metrics"
        minute: "*/5"
        job: "/usr/local/bin/speedtest-metrics.sh"
        user: root

    - name: Run initial speedtest
      command: /usr/local/bin/speedtest-metrics.sh
      async: 120
      poll: 0

    - name: Check if blackbox-exporter is installed
      stat:
        path: /usr/local/bin/blackbox_exporter
      register: blackbox_installed

    - name: Download blackbox-exporter
      get_url:
        url: "https://github.com/prometheus/blackbox_exporter/releases/download/v{{ blackbox_exporter_version }}/blackbox_exporter-{{ blackbox_exporter_version }}.linux-armv7.tar.gz"
        dest: "/tmp/blackbox_exporter.tar.gz"
      when: not blackbox_installed.stat.exists

    - name: Extract blackbox-exporter
      unarchive:
        src: "/tmp/blackbox_exporter.tar.gz"
        dest: /tmp
        remote_src: yes
      when: not blackbox_installed.stat.exists

    - name: Copy blackbox-exporter binary
      copy:
        src: "/tmp/blackbox_exporter-{{ blackbox_exporter_version }}.linux-armv7/blackbox_exporter"
        dest: /usr/local/bin/blackbox_exporter
        mode: "0755"
        remote_src: yes
      when: not blackbox_installed.stat.exists

    - name: Create blackbox-exporter config directory
      file:
        path: /etc/blackbox_exporter
        state: directory
        mode: "0755"

    - name: Create blackbox-exporter configuration
      copy:
        dest: /etc/blackbox_exporter/config.yml
        content: |
          modules:
            http_2xx:
              prober: http
              timeout: 5s
              http:
                valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
                valid_status_codes: []  # Defaults to 2xx
                method: GET
                preferred_ip_protocol: "ip4"
                follow_redirects: true
        mode: "0644"

    - name: Create blackbox-exporter systemd service
      copy:
        dest: /etc/systemd/system/blackbox-exporter.service
        content: |
          [Unit]
          Description=Blackbox Exporter
          After=network.target

          [Service]
          Type=simple
          User=nobody
          ExecStart=/usr/local/bin/blackbox_exporter --config.file=/etc/blackbox_exporter/config.yml
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    - name: Enable and start blackbox-exporter
      systemd:
        name: blackbox-exporter
        state: started
        enabled: yes
        daemon_reload: yes

    - name: Display status
      debug:
        msg:
          - "Internet monitoring exporters installed!"
          - ""
          - "Speedtest metrics: Available via node_exporter at http://{{ ansible_host }}:9100/metrics (look for speedtest_* metrics)"
          - "Blackbox exporter: http://{{ ansible_host }}:9115/metrics"
          - ""
          - "Next: Update Prometheus config to scrape blackbox exporter"

- name: Update Prometheus configuration for internet monitoring
  hosts: monitoring
  become: yes
  vars:
    monitoring_dir: /opt/monitoring

  tasks:
    - name: Update Prometheus configuration with internet monitoring jobs
      copy:
        dest: "{{ monitoring_dir }}/prometheus.yml"
        content: |
          global:
            scrape_interval: 15s
            evaluation_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['localhost:9090']
                  labels:
                    instance: 'prometheus'

            - job_name: 'raspberry-pi'
              static_configs:
                - targets: ['192.168.68.58:9100']
                  labels:
                    instance: 'raspberry-pi'
                    role: 'network-core'

            - job_name: 'proxmox-host'
              static_configs:
                - targets: ['192.168.68.11:9100']
                  labels:
                    instance: 'proxmox-host'
                    role: 'hypervisor'

            - job_name: 'monitor-lxc'
              static_configs:
                - targets: ['192.168.68.20:9100']
                  labels:
                    instance: 'monitor-lxc'
                    role: 'monitoring'

            # Website uptime/latency monitoring
            - job_name: 'blackbox-http'
              metrics_path: /probe
              params:
                module: [http_2xx]
              static_configs:
                - targets:
                    - https://ashishra0.com
                    - https://x.com
                    - https://github.com
              relabel_configs:
                - source_labels: [__address__]
                  target_label: __param_target
                - source_labels: [__param_target]
                  target_label: instance
                - target_label: __address__
                  replacement: 192.168.68.58:9115

            # Blackbox exporter itself
            - job_name: 'blackbox-exporter'
              static_configs:
                - targets: ['192.168.68.58:9115']

            # Tapo power monitoring
            - job_name: 'tapo-power'
              static_configs:
                - targets: ['192.168.68.20:9200']
                  labels:
                    instance: 'homelab-ups'
                    device: 'tapo-p110'
        mode: "0644"
      notify: restart prometheus

  handlers:
    - name: restart prometheus
      community.docker.docker_compose_v2:
        project_src: "{{ monitoring_dir }}"
        services:
          - prometheus
        state: restarted
